generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(uuid())
  name               String
  surname            String?
  email              String              @unique
  phone              String?             @unique
  qrCode             String              @unique
  createdAt          DateTime            @default(now())
  password           String
  verified           Boolean             @default(false) // üëà ekledik
  totalEarnings      Float               @default(0) // üèÜ Rozet sistemi i√ßin toplam kazan√ß
  purchases          Purchase[]
  userPoints         UserPoints[]
  pointsUsages       PointsUsage[]
  verificationTokens   VerificationToken[]   // üëà ili≈üki
  passwordResetTokens  PasswordResetToken[]  // ≈ûifre sƒ±fƒ±rlama
  consents             UserConsent[]         // KVKK rƒ±za kayƒ±tlarƒ±
  dsarRequests         DsarRequest[]         // KVKK veri talepleri
}

model Company {
  id                 String   @id @default(uuid())
  name               String
  email              String   @unique
  password           String
  address            String?
  cashbackPercentage Float    @default(3) // Varsayƒ±lan %3
  createdAt          DateTime @default(now())
  categories         Category[]
  products           Product[]
  purchases          Purchase[]
  userPoints         UserPoints[]
  pointsUsages       PointsUsage[]
  campaigns              Campaign[]
  verified               Boolean                       @default(false)
  verificationTokens     CompanyVerificationToken[]
  passwordResetTokens    CompanyPasswordResetToken[]   // ≈ûifre sƒ±fƒ±rlama
  staff                  CompanyStaff[]
}

model CompanyStaff {
  id        String  @id @default(uuid())
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId String
  name     String
  email    String  @unique
  password String
  isActive Boolean @default(true)
  createdAt DateTime @default(now())

  purchases    Purchase[]
  pointsUsages PointsUsage[]
}

model Category {
  id   Int    @id @default(autoincrement())
  name String

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId String

  products Product[]
}

model Product {
  id        Int      @id @default(autoincrement())
  name      String
  price     Float
  cashback  Float    @default(0) // ‚úÖ artƒ±k TL iade alanƒ±
  createdAt DateTime @default(now())
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId String
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  categoryId Int?
  purchases    Purchase[]
  pointsUsages PointsUsage[] // ‚úÖ tekrar eklendi
}

/// Satƒ±n almalar
model Purchase {
  id             Int      @id @default(autoincrement())
  quantity       Int      @default(1)
  totalPrice     Float
  cashbackEarned Float    @default(0)
  purchaseDate   DateTime @default(now())

  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId String

  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  productId Int?

  // üëá personeli izlemek i√ßin (opsiyonel, bozulma yok)
  createdByStaff   CompanyStaff? @relation(fields: [createdByStaffId], references: [id], onDelete: SetNull)
  createdByStaffId String?
}

/// M√º≈üteri puanlarƒ±
model UserPoints {
  id          Int @id @default(autoincrement())
  totalPoints Int @default(0)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId String

  @@unique([userId, companyId])
}

/// Kullanƒ±lan puanlar
model PointsUsage {
  id       Int      @id @default(autoincrement())
  amount   Int
  quantity Int      @default(1)
  price    Float    @default(0)
  usedAt   DateTime @default(now())

  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId String

  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  productId Int?

  // üëá personeli izlemek i√ßin (opsiyonel, bozulma yok)
  createdByStaff   CompanyStaff? @relation(fields: [createdByStaffId], references: [id], onDelete: SetNull)
  createdByStaffId String?
}

model Campaign {
  id        Int      @id @default(autoincrement())
  title     String
  detail    String?
  startDate DateTime
  endDate   DateTime
  createdAt DateTime @default(now())

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId String
}

model VerificationToken {
  id      Int      @id @default(autoincrement())
  token   String   @unique
  expires DateTime

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  createdAt DateTime @default(now())
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  expires   DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  createdAt DateTime @default(now())
}

model CompanyPasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  expires   DateTime
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId String
  createdAt DateTime @default(now())
}

model CompanyVerificationToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId String
  expires   DateTime
  createdAt DateTime @default(now())
}

/// KVKK - Rƒ±za y√∂netimi (Consent tracking)
model UserConsent {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  
  consentType String  // "marketing", "analytics", "profiling", etc.
  granted     Boolean @default(false)
  grantedAt   DateTime?
  revokedAt   DateTime?
  ipAddress   String?
  userAgent   String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, consentType])
}

/// KVKK - Veri talebi kayƒ±tlarƒ± (DSAR - Data Subject Access Requests)
model DsarRequest {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  
  requestType String   // "export", "delete", "rectify"
  status      String   @default("pending") // "pending", "processing", "completed", "rejected"
  details     String?  // JSON string with request details
  response    String?  // Admin response or processing notes
  
  requestedAt DateTime @default(now())
  processedAt DateTime?
  completedAt DateTime?
  
  ipAddress   String?
  
  @@index([userId, requestType])
  @@index([status])
}

/// Audit log i√ßin veri deƒüi≈üikliƒüi kayƒ±tlarƒ±
model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  // Nullable - system actions may not have userId
  action    String   // "user.update", "user.delete", "consent.grant", etc.
  entityType String  // "User", "Purchase", "Consent", etc.
  entityId  String
  changes   String?  // JSON string with before/after values
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}